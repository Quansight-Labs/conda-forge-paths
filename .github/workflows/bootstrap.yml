name: Update database

on:
  push:
    branches:
      - main

  pull_request:

  workflow_dispatch:

  schedule:
    - cron: "0 5 * * 1" # Mondays @ 5am
    - cron: "0 1 1 * *" # First day of the month @ 1am

concurrency:
  # Concurrency group that uses the workflow name and PR number if available
  # or commit SHA as a fallback. If a new build is triggered under that
  # concurrency group while a previous build is running it will be canceled.
  # Repeated pushes to a PR will cancel all previous builds, while multiple
  # merges to main will not cancel.
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  DBNAME: path_to_artifacts
  PYTHONUNBUFFERED: 1

jobs:
  update:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}

    steps:
      - name: Free Disk Space
        uses: endersonmenezes/free-disk-space@6c4664f43348c8c7011b53488d5ca65e9fc5cd1a  # v3.0.0
        with:
          remove_android: true
          remove_dotnet: true
          remove_haskell: true
          remove_tool_cache: true
          remove_swap: true
          remove_packages: >-
            azure-cli
            google-cloud-cli
            microsoft-edge-stable
            google-chrome-stable
            firefox
            postgresql*
            temurin-*
            *llvm*
            mysql*
            dotnet-sdk-*
          remove_packages_one_command: true
          remove_folders: >-
            /usr/share/swift
            /usr/share/miniconda
            /usr/share/az*
            /usr/local/lib/node_modules
            /usr/local/share/chromium
            /usr/local/share/powershell
            /usr/local/julia
            /usr/local/aws-cli
            /usr/local/aws-sam-cli
            /usr/share/gradle
          rm_cmd: "rmz"
          rmz_version: "3.1.1"
          testing: false

      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Fetch latest release
        run: |
          set -x
          curl -L -o ${DBNAME}.tar.zst \
            https://github.com/${GITHUB_REPOSITORY}/releases/latest/download/${DBNAME}.tar.zst
          tar xf ${DBNAME}.tar.zst
          rm ${DBNAME}.tar.zst

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7 # v0.9.3

      - name: Update database with most recent repodata
        run: |
          set -x
          ls -alh *.db
          pixi run python conda_forge_paths/path_to_artifacts_db.py update-from-repodata
          ls -alh *.db

      - name: Update FTS index
        run: |
          set -x
          ls -alh *.db
          pixi run python conda_forge_paths/path_to_artifacts_db.py fts
          ls -alh *.db

      - name: Get current time
        uses: josStorer/get-current-time@060cae3fbd32c181c6841788189a601ac8df8389 # v2.1.2
        id: current-time
        with:
          format: "YYYY-MM-DD"
          utcOffset: "+00:00"

      - name: Compress DB file (for quick tests)
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        run: |
          ZSTD_NBTHREADS=$(nproc) ZSTD_CLEVEL=9 tar --zstd -cf ${DBNAME}.tar.zst ${DBNAME}.db
          ls -alh ${DBNAME}.*

      - name: Compress DB file (for release)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          ZSTD_NBTHREADS=$(nproc) ZSTD_CLEVEL=19 tar --zstd -cf ${DBNAME}.tar.zst ${DBNAME}.db
          ls -alh ${DBNAME}.*

      - name: Generate SHA256 checksums
        run: |
          openssl sha256 ${DBNAME}.db > ${DBNAME}.db.sha256
          openssl sha256 ${DBNAME}.tar.zst > ${DBNAME}.tar.zst.sha256

      - name: Remove uncompressed database
        run: |
          rm ${DBNAME}.db
          rm ${DBNAME}.db-journal || true

      - name: "Upload Artifact"
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        with:
          name: database
          path: ${{ env.DBNAME }}.*
          retention-days: 60
          compression-level: 0

      - name: Publish weekly
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        if: github.event_name == 'schedule' && !endsWith(steps.current-time.outputs.formattedTime, '-01')
        with:
          draft: false
          name: "Latest Release"
          tag_name: "latest"
          files: ${{ env.DBNAME }}.*
          fail_on_unmatched_files: true
          body: |
            Weekly snapshot of the conda-forge path-to-artifacts database.
            Last updated on ${{ steps.current-time.outputs.formattedTime }}.
            See the README for more information.

      - name: Publish monthly or manually
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        if: ( github.event_name == 'schedule' && endsWith(steps.current-time.outputs.formattedTime, '-01') ) || github.event_name == 'workflow_dispatch'
        with:
          draft: false
          name: ${{ steps.current-time.outputs.formattedTime }}
          tag_name: ${{ steps.current-time.outputs.formattedTime }}
          files: ${{ env.DBNAME }}.*
          fail_on_unmatched_files: true
          body: |
            ${{ steps.current-time.outputs.formattedTime }} snapshot of the conda-forge path-to-artifacts database.
